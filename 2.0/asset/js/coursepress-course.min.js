var CoursePress=CoursePress||{};CoursePress.Events=CoursePress.Events||_.extend({},Backbone.Events),function(e){function t(){e("#course-setup-steps").accordion({disabled:!0,autoHeight:!1,collapsible:!0,heightStyle:"content",active:0,animate:200}),_coursepress.course_title&&(e(".coursepress_settings_wrapper h1").append(": <small>"+_coursepress.course_title+"</small>"),e("#course_name").on("change",function(){e(".coursepress_settings_wrapper h1 small").html(e(this).val())})),e("#course-setup-steps .step-title").bind("click",function(){var s=jQuery(this),t=parseInt(s.attr("class").match(/step-\d{1,10}/g)[0].trim().split("-").pop()),r=t-1>1?t-1:1;return s.find(".status").hasClass("saved")||e(".step-title.step-"+r).find(".status").hasClass("saved")?(e("#course-setup-steps").accordion("enable").accordion({active:t-1}).accordion("disable"),void setTimeout(function(){var t=s.offset();e("body,html").animate({scrollTop:t.top-110,duration:200})},200)):void s.effect("highlight",{color:"#ffabab",duration:300})}),e(".chosen-select.medium").chosen({disable_search_threshold:5,width:"40%"}),e(".chosen-select.narrow").chosen({disable_search_threshold:5,width:"20%"});var s=e("table.course-structure-tree"),t=e("tr",s);if(100>t&&e("table.course-structure-tree").treegrid({initialState:"expanded"}),"function"==typeof e(document).datetimepicker){var r=e(".dateinput.timeinput").datetimepicker({dateFormat:"yy-mm-dd",timeFormat:"HH:mm",showButtonPanel:!1,timeInput:!0,controlType:"select",oneLine:!0,autoclose:!0,onSelect:function(){r.datepicker("hide")}});e(".dateinput").not(".dateinput.timeinput").datepicker({dateFormat:"yy-mm-dd",autoclose:!0})}e(".date").click(function(){e(this).parents("div").hasClass("disabled")||e(this).find(".dateinput").datepicker("show")}),e('[name="meta_enrollment_open_ended"]').change(function(){this.checked?(e(this).parents(".enrollment-dates").find(".start-date").addClass("disabled"),e(this).parents(".enrollment-dates").find(".start-date input").attr("disabled","disabled"),e(this).parents(".enrollment-dates").find(".end-date").addClass("disabled"),e(this).parents(".enrollment-dates").find(".end-date input").attr("disabled","disabled")):(e(this).parents(".enrollment-dates").find(".start-date").removeClass("disabled"),e(this).parents(".enrollment-dates").find(".start-date input").removeAttr("disabled"),e(this).parents(".enrollment-dates").find(".end-date").removeClass("disabled"),e(this).parents(".enrollment-dates").find(".end-date input").removeAttr("disabled"))}),e('[name="meta_course_open_ended"]').change(function(){this.checked?(e(this).parents(".course-dates").find(".end-date").addClass("disabled"),e(this).parents(".course-dates").find(".end-date input").attr("disabled","disabled")):(e(this).parents(".course-dates").find(".end-date").removeClass("disabled"),e(this).parents(".course-dates").find(".end-date input").removeAttr("disabled"))}),e(".spinners").spinner(),e('[name="meta_class_limited"]').change(function(){this.checked?(e(this).parents(".class-size").find(".num-students").removeClass("disabled"),e(this).parents(".class-size").find(".num-students input").removeAttr("disabled")):(e(this).parents(".class-size").find(".num-students").addClass("disabled"),e(this).parents(".class-size").find(".num-students input").attr("disabled","disabled"))}),e(".coursepress-ui-toggle-switch").coursepress_ui_toggle()}function r(){e("#course-setup-steps input").on("keyup change",function(){var s=e(this).parents(".cp-box-content")[0];e(s).find(".button.update.hidden").removeClass("hidden")}),e("#course-setup-steps select").on("change",function(){var s=e(this).parents(".cp-box-content")[0];e(s).find(".button.update.hidden").removeClass("hidden")}),CoursePress.Events.on("editor:keyup",function(s){var t=e(s.container).parents(".cp-box-content")[0];e(t).find(".button.update.hidden").removeClass("hidden")}),e(".cp-box-content .button.step.prev, .cp-box-content .button.step.next, .cp-box-content .button.step.update, .cp-box-content .button.step.finish").on("click",function(s){var r,o,t=jQuery(s.currentTarget);r=t.hasClass("step-1")?1:null,r=t.hasClass("step-2")?2:r,r=t.hasClass("step-3")?3:r,r=t.hasClass("step-4")?4:r,r=t.hasClass("step-5")?5:r,r=t.hasClass("step-6")?6:r,r=t.hasClass("step-7")?7:r;var n=[];if(r>=1&&n.push("course_name","course_excerpt"),r>=4&&(n.push("meta_course_start_date"),e('[name="meta_course_open_ended"]').is(":checked")||n.push("meta_course_end_date"),e('[name="meta_enrollment_open_ended"]').is(":checked")||n.push("meta_enrollment_start_date","meta_enrollment_end_date")),r>=7&&(n.push("meta_minimum_grade_required","meta_pre_completion_title","meta_pre_completion_content"),n.push("meta_course_completion_title","meta_course_completion_content","meta_course_failed_title","meta_course_failed_content")),n.length>0){var i,a=0;if(i=function(s,t){var r=tinyMCE&&tinyMCE.get(s)?tinyMCE.get(s).getContent():t.val();return""==r&&(r=e("#"+s).val()),r},_.each(n,function(s){var t=e('[name="'+s+'"]'),r=t.val();t.removeClass("error"),"course_excerpt"==s&&(r=i("courseExcerpt",t)),"course_description"==s&&(r=i("courseDescription",t)),"meta_pre_completion_content"==s&&(r=i("pre-completion-content",t)),"meta_course_completion_content"==s&&(r=i("course-completion-editor-content",t)),"meta_course_failed_content"==s&&(r=i("course-failed-content",t)),r&&""!=r||(t.addClass("error"),a+=1)}),a>0)return CoursePress.Course.hasError=!0,alert(_coursepress.labels.required_fields),!1;CoursePress.Course.hasError=!1}o=t.hasClass("prev")?"prev":null,o=t.hasClass("next")?"next":o,o=t.hasClass("update")?"update":o,o=t.hasClass("finish")?"finish":o,null!==r&&(CoursePress.Course.show_message(_coursepress.unit_builder_form.messages.setup.saving,"info"),e(".step-title.step-"+r).find(".status").removeClass("saved"),e(".step-title.step-"+r).find(".status").removeClass("save-error"),e(".step-title.step-"+r).find(".status").removeClass("save-attention"),e(".step-title.step-"+r).find(".status").addClass("save-process"),CoursePress.Course.get_step(r,o),CoursePress.Course.save())}),e(".button.browse-media-field").browse_media_field(),e.fn.wpColorPicker&&e(".certificate-color-picker").wpColorPicker(),e('.cp-box-content .course-structure input[type="checkbox"]').on("change",function(s){var t=e(s.currentTarget),r=t.attr("name"),o=null!=r.match(/visible/)?"visible":"preview",n="meta_structure_"+o,a=e(".course-structure-tree"),i=t.is(":checked"),c=t.parents("tr").first(),u=c.attr("data-unitid"),l=function(s){var t=a.find('tr[data-unitid="'+u+'"]').find('[name*="'+n+'_pages"]');t.each(function(){{var t=e(this);t.is(":checked")}p=t.parents("tr[data-pagenumber]").first().attr("data-pagenumber"),s?t.attr("checked",!0):t.attr("checked",!1),d(s,p)})},d=function(s,t){var r=a.find('tr[data-unitid="'+u+'"][data-pagenumber="'+t+'"]').find('[name*="'+n+'_modules"]');r.each(function(){{var t=e(this);t.is(":checked")}s?t.attr("checked",!0):t.attr("checked",!1)})};if(r.match(/_units/))l(i);else if(r.match(/_pages/)){var p=t.parents("tr").first().attr("data-pagenumber"),f=a.find(".unit-"+u).find('[name*="'+n+'_unit"]'),m=a.find('.page[data-unitid="'+u+'"]').find('[name*="'+n+'_pages"]:checked');f.attr("checked",m.length>0),d(i,p)}else{var p=c.attr("data-pagenumber"),f=a.find(".unit-"+u).find('[name*="'+n+'_unit"]'),_=a.find(".page-"+p+'[data-unitid="'+u+'"]').find('[name*="'+n+'_page"]'),v=a.find('tr[data-unitid="'+u+'"][data-pagenumber="'+p+'"]').find('[name*="'+n+'_modules"]:checked');_.attr("checked",v.length>0);var m=a.find('.page[data-unitid="'+u+'"]').find('[name*="'+n+'_pages"]:checked');f.attr("checked",m.length>0)}}),e(".button.instructor-assign").on("click",function(){if(e(this).hasClass("disabled"))return!1;var s=e('select[name="instructors"]'),t=parseInt(s.val()),r=s.html(),o=e("#instructor_holder_"+t).length>0,n=e(".select2-selection__rendered"),i=e("#instructors-info");if(!o){n.html(_coursepress.labels.user_dropdown_placeholder);{e('<div class="instructor-avatar-holder empty" id="instructor_holder_'+t+'"><span class="fa fa-circle-o-notch fa-spin fa-2x fa-fw"></span></div>').appendTo(i)}CoursePress.Course.set("action","add_instructor");var u={instructor_id:t,course_id:_coursepress.course_id,instructor_name:r,nonce:a()};CoursePress.Course.set("data",u),CoursePress.Course.save()}}),o(".avatar-holder .remove a"),e(".instructor-invite input").keypress(function(s){if(13===s.which){switch(e(this).attr("name")){case"invite_instructor_first_name":e("[name=invite_instructor_last_name]").trigger("focus");break;case"invite_instructor_last_name":e("[name=invite_instructor_email]").trigger("focus");break;case"invite_instructor_email":case"invite_instructor_trigger":e("#invite-instructor-trigger").trigger("click"),e("[name=invite_instructor_first_name]").trigger("focus")}s.preventDefault()}}),e("#invite-instructor-trigger").on("click",function(){var s=e("[name=invite_instructor_email]").val(),t=e("[name=invite_instructor_first_name]").val(),r=e("[name=invite_instructor_last_name]").val(),o=e("[name=invite_instructor_type]:checked").val(),n=null!==s.match(_coursepress.email_validation_pattern);if(n){CoursePress.Course.set("action","invite_instructor");var i={first_name:t,last_name:r,who:o,email:s,course_id:_coursepress.course_id,nonce:a()};CoursePress.Course.set("data",i),CoursePress.Course.on("coursepress:invite_instructor_success",function(){e('[name="invite_instructor_first_name"],[name="invite_instructor_last_name"],[name="invite_instructor_email"]').val("")}),CoursePress.Course.save()}}),e('[name="meta_enrollment_type"]').on("change",function(){var s=e(this).val();e(".cp-box-content.step-6 .enrollment-type-options").addClass("hidden"),e(".step-content.step-6 .enrollment-type-options."+s).removeClass("hidden")}),e('[name="meta_second_formula_course"]').on("change",function(){this.checked?e(this).parents(".cp-box-content.step-6").find(".has2_formula_toggle").removeClass("hidden"):e(this).parents(".cp-box-content.step-6").find(".has2_formula_toggle").addClass("hidden")}),e('[name="meta_second_formula_tag"]').on("change",function(){""==e(this).val()&&e(this).val(e(this).parents(".cp-box-content.step-6").find('[name="meta_second_formula_name"]').val())}),e('[name="meta_base_formula_tag"]').on("change",function(){""==e(this).val()&&e(this).val(e(this).parents(".cp-box-content.step-6").find('[name="meta_base_formula_name"]').val())}),e('[name="meta_payment_paid_course"]').on("change",function(){this.checked?(e(this).parents(".cp-box-content.step-6").find(".payment-message").removeClass("hidden"),e(this).parents(".cp-box-content.step-6").find(".is_paid_toggle").removeClass("hidden")):(e(this).parents(".cp-box-content.step-6").find(".payment-message").addClass("hidden"),e(this).parents(".cp-box-content.step-6").find(".is_paid_toggle").addClass("hidden"))}),e('[name="publish-course-toggle"]').on("change",function(s,t){var r=e(this).attr("data-nonce"),o="off"===t?"draft":"publish";CoursePress.Course.set("action","toggle_course_status");var n={nonce:r,status:o,state:t,course_id:_coursepress.course_id};CoursePress.Course.set("data",n),CoursePress.Course.save()}),e(".add-new-student-button").on("click",function(s){s.stopImmediatePropagation(),s.preventDefault();var t=e(this).attr("data-nonce");CoursePress.Course.set("action","enroll_student");var r={nonce:t,course_id:_coursepress.course_id,student_id:e("#student-add").val()};CoursePress.Course.set("data",r),CoursePress.Course.save()}),e("a.withdraw-student").on("click",function(){if(window.confirm(_coursepress.student_delete_confirm)){CoursePress.Course.set("action","withdraw_student");var s={student_id:e(this).attr("data-id"),course_id:_coursepress.course_id,nonce:e(this).attr("data-nonce")};return CoursePress.Course.set("data",s),CoursePress.Course.save(),CoursePress.Course.on("coursepress:withdraw_student_success",function(){window.location.reload()}),!1}}),e("a.withdraw-all-students").on("click",function(){if(window.confirm(_coursepress.student_delete_all_confirm)){CoursePress.Course.set("action","withdraw_all_students");var s={course_id:_coursepress.course_id,nonce:e(this).attr("data-nonce")};return CoursePress.Course.set("data",s),CoursePress.Course.save(),CoursePress.Course.on("coursepress:withdraw_all_students_success",function(){window.location.reload()}),!1}}),e(".coursepress_course_invite_student_wrapper input").keypress(function(s){if(13===s.which){switch(e(this).attr("name")){case"invite-firstname":e("[name=invite-lastname]").trigger("focus");break;case"invite-lastname":e("[name=invite-email]").trigger("focus");break;case"invite-email":case".coursepress_course_invite_student_wrapper .invite-submit":e(".coursepress_course_invite_student_wrapper .invite-submit").trigger("click"),e("[name=invite-firstname]").trigger("focus")}s.preventDefault()}}),e(".coursepress_course_invite_student_wrapper .invite-submit").on("click",function(){var s=e("[name=invite-email]").val(),t=e("[name=invite-firstname]").val(),r=e("[name=invite-lastname]").val(),o=null!==s.match(_coursepress.email_validation_pattern);if(o){e(".coursepress_course_invite_student_wrapper .invite-submit").prepend('<i class="fa fa-spinner fa-spin invite-progress"></i> '),CoursePress.Course.set("action","invite_student");var n={first_name:t,last_name:r,email:s,course_id:_coursepress.course_id,nonce:e(this).attr("data-nonce")};CoursePress.Course.set("data",n),CoursePress.Course.save(),CoursePress.Course.on("coursepress:invite_student_success",function(){window.location.reload()})}e("[name=invite-email]").val(""),e("[name=invite-firstname]").val(""),e("[name=invite-lastname]").val("")}),e(".column-actions .resend-invite").on("click",function(){var s=e(this),t=s.data();return e("[name=invite-email]").val(t.email),e("[name=invite-firstname]").val(t.firstname),e("[name=invite-lastname]").val(t.lastname),e(".coursepress_course_invite_student_wrapper .invite-submit").trigger("click"),!1}),e(".column-actions .remove-invite").on("click",function(){var s=this,t=e(this).data(),r={email:t.email,nonce:t.nonce,course_id:_coursepress.course_id};return CoursePress.Course.set("action","remove_student_invitation"),CoursePress.Course.set("data",r),CoursePress.Course.save(),CoursePress.Course.on("coursepress:remove_student_invitation_success",function(){e(s).parents("tr").first().slideUp(function(){e(this).remove();var s=e(".invited-list");s.length||e(".invited-students").hide()})}),!1}),e(".button.facilitator-assign").on("click",function(){if(e(this).hasClass("disabled"))return!1;var s=e('[name="facilitators"]'),t=s.val(),r=s.find(":selected").text(),n=(_coursepress.instructor_avatars["default"],e(".facilitator-info")),i=e("#facilitator-"+t).length>0,c=e(".select2-selection__rendered");if(!i){c.html(_coursepress.labels.user_dropdown_placeholder);{var u={facilitator_id:t,facilitator_name:r,course_id:_coursepress.course_id,nonce:a()};e('<div class="facilitator-avatar-holder empty" id="facilitator-'+t+'"><span class="fa fa-circle-o-notch fa-spin fa-2x fa-fw"></span></div>').appendTo(n)}CoursePress.Course.set("action","add_facilitator"),CoursePress.Course.set("data",u),CoursePress.Course.save()}}),CoursePress.remove_facilitator=function(){var s=e(this).parent(),t=s.data("id");s.hide();var r={facilitator_id:t,nonce:a(),course_id:_coursepress.course_id};CoursePress.Course.set("action","remove_facilitator"),CoursePress.Course.set("data",r),CoursePress.Course.save()},e(".facilitator-remove").on("click",CoursePress.remove_facilitator),e(".coursepress_course_email_enroled_students_wrapper .send-submit").on("click",function(){var s=e('[name="send_to"]').val(),t=e("[name=email-subject]").val(),r=e("[name=email-body]").val(),o=e("#send-email-to-enroled-students");e(".coursepress_course_email_enroled_students_wrapper .send-submit").hide(),e(".coursepress-email-field",o).slideUp(),e(".coursepress-email-sending",o).slideDown(),CoursePress.Course.set("action","send_email");var n={send_to:s,subject:t,body:r,course_id:_coursepress.course_id,nonce:e(this).attr("data-nonce")};CoursePress.Course.set("data",n),CoursePress.Course.save(),CoursePress.Course.off("coursepress:send_email_success"),CoursePress.Course.on("coursepress:send_email_success",function(s){e(".coursepress-email-sending td",o).html(s.message.info),e(".coursepress-email-field-subject td",o).html(s.message.subject),e(".coursepress-email-field-body td",o).html(s.message.body),e(".coursepress-email-field",o).slideDown()}),CoursePress.Course.off("coursepress:send_email_error"),CoursePress.Course.on("coursepress:send_email_error",function(s){e(".coursepress-email-sending td",o).html(s.message.info),e(".coursepress-email-field-subject td",o).html(s.message.subject),e(".coursepress-email-field-body td",o).html(s.message.body),e(".coursepress-email-field",o).slideDown()})})}function o(s){e(s).on("click",function(s){var r,o,n,t=s.currentTarget,i=e(t).parents(".avatar-holder").data();switch(i.status){case"confirmed":n=_coursepress.instructor_delete_confirm,"facilitator"===i.who&&(n=_coursepress.facilitator_delete_confirm),window.confirm(n)&&(e(t).html('<span class="fa fa-circle-o-notch fa-spin fa-2x fa-fw"></span>'),e(t).parent().addClass("removing-process"),r=e(t).parents(".cp-box-content")[0],e(r).find(".button.update.hidden").removeClass("hidden"),CoursePress.Course.set("action","delete_instructor"),o={instructor_id:i.id,who:i.who,course_id:_coursepress.course_id,nonce:a()},CoursePress.Course.set("data",o),CoursePress.Course.save(),e("#student-add, #facilitators, #instructors").select2("val",""));break;case"pending":n=_coursepress.instructor_delete_invite_confirm,"facilitator"===i.who&&(n=_coursepress.facilitator_delete_invite_confirm),window.confirm(n)&&(e(t).html('<span class="fa fa-circle-o-notch fa-spin fa-2x fa-fw"></span>'),e(t).parent().addClass("removing-process"),r=e(t).parents(".cp-box-content")[0],e(r).find(".button.update.hidden").removeClass("hidden"),CoursePress.Course.set("action","delete_instructor_invite"),o={invite_code:i.code,who:i.who,course_id:_coursepress.course_id,nonce:a()},CoursePress.Course.set("data",o),CoursePress.Course.save())}})}function n(s){s.nonce&&e("#course-setup-steps").attr("data-nonce",s.nonce)}function a(){return e("#course-setup-steps").attr("data-nonce")}function i(){CoursePress.Course.on("coursepress:update_course_success",function(s){s.last_step==s.next_step&&CoursePress.Course.show_message(_coursepress.unit_builder_form.messages.setup.saved,"success"),e(".step-title.step-"+s.last_step).find(".status").addClass("saved"),e(".step-title.step-"+s.last_step).find(".status").removeClass("save-error"),e(".step-title.step-"+s.last_step).find(".status").removeClass("save-attention"),e(".step-title.step-"+s.last_step).find(".status").removeClass("save-process"),s.next_step!==s.last_step&&e(".step-title.step-"+s.next_step).click();var t=e(".step-content.step-"+s.last_step).find(".course-step-buttons")[0];if(e("#step-done-message").remove(),e(t).append('<span id="step-done-message">&nbsp;<i class="fa fa-check"></i></span>'),e("#step-done-message").show(function(){e(this).fadeOut(1e3)}),e(t).find(".update").addClass("hidden"),e('[name="course_id"]').val(s.course_id),_coursepress.course_id=s.course_id,n(s),s.redirect){var r=location.href.replace("&tab=setup","");/\&post/.test(r)||(r+="&post="+s.course_id),/\&action=edit/.test(r)||(r+="&action=edit"),/post-new.php/.test(r)&&(r=r.replace(/post-new.php/,"post.php")),location.href=r+"&tab=units"}else{var o=e("#edit_course_link_url");o.length>0&&window.history.pushState&&window.history.pushState({},null,o.val())}}),CoursePress.Course.on("coursepress:update_course_error",function(s){CoursePress.Course.show_message(_coursepress.unit_builder_form.messages.setup.error,"error"),e(".step-title.step-"+s.last_step).find(".status").removeClass("saved"),e(".step-title.step-"+s.last_step).find(".status").addClass("save-error"),e(".step-title.step-"+s.last_step).find(".status").removeClass("save-attention"),e(".step-title.step-"+s.last_step).find(".status").removeClass("save-process")}),CoursePress.Course.on("coursepress:add_instructor_success",function(s){var t="",r=_coursepress.instructor_avatars["default"],a=wp.template("course-person");e("input.button.instructor-assign").addClass("disabled"),s.avatar&&(r=s.avatar),e("#"+s.who+"_holder_"+s.id).remove(),t+=a(s),"instructor"==s.who&&e(".instructor-avatar-holder.empty").length>0&&e(".instructor-avatar-holder.empty").detach(),0===e("#"+s.who+"_holder_"+s.id).length&&(e("#"+s.who+"s-info").append(t),o("#"+s.who+"_holder_"+s.id+" .remove a")),n(s)}),CoursePress.Course.on("coursepress:delete_instructor_success",function(s){if(e("#"+s.who+"_holder_"+s.instructor_id).detach(),"instructor"==s.who){var t='<div class="instructor-avatar-holder empty"><span class="instructor-name">'+_coursepress.instructor_empty_message+"</span></div>";0===e(".instructor-avatar-holder").length&&e("#instructors-info").append(t)}n(s)}),CoursePress.Course.on("coursepress:invite_instructor_success",function(s){var t=wp.template("course-invitation"),r=s.data.email,a=s.invite_code,u=(CoursePress.utility.get_gravatar_image(r,80),""),l="",d="instructor",p=s.data;"undefined"!=typeof s.data.who&&(d=s.data.who),p.who=d,p.code=a,p.avatar=s.avatar,u+=t(p),"instructor"==d&&e(".instructor-avatar-holder.empty",parent).length>0&&e(".instructor-avatar-holder.empty",parent).detach(),0===e("#"+d+"_holder_"+a).length?(e("#"+d+"s-info").append(u),o("#"+d+"_holder_"+a+" .remove a"),l=' <span class="message"><span class="dashicons dashicons-yes"></span> '+s.message.sent+"</span>"):l=' <span class="message"><span class="dashicons dashicons-yes"></span> '+s.message.exists+"</span>",e(".instructor-invite .submit-message").append(l),e(".instructor-invite .submit-message .message").fadeOut(3e3),n(s)}),CoursePress.Course.on("coursepress:invite_instructor_error",function(s){var t=' <span class="message"><span class="dashicons dashicons-yes"></span> '+s.message.send_error+"</span>";e(".instructor-invite .submit-message").append(t),e(".instructor-invite .submit-message .message").fadeOut(3e3),n(s)}),CoursePress.Course.on("coursepress:delete_instructor_invite_success",function(s){var t="instructor";"undefined"!=typeof s.who&&(t=s.who),e("#"+t+"_holder_"+s.invite_code).detach(),n(s)}),CoursePress.Course.on("coursepress:add_facilitator_success",function(s){var t=wp.template("course-person"),a=(s.facilitator_id,_coursepress.instructor_avatars["default"]);e("input.button.facilitator-assign").addClass("disabled"),s.avatar&&(a=s.avatar),content=t(s),0===e("#"+s.who+"_holder_"+s.id).length&&(e("#"+s.who+"-"+s.id).detach(),e("#"+s.who+"s-info").append(content),o("#"+s.who+"_holder_"+s.id+" .remove a")),n(s)}),CoursePress.Course.on("coursepress:add_facilitator_error",function(s){var t=e("#facilitator-"+s.facilitator_id).empty();t.html(s.message),t.fadeOut(3e3,function(){t.remove()}),n(s)}),CoursePress.Course.on("coursepress:remove_facilitator_success",function(s){var t=e("#facilitator-"+s.facilitator_id);t.remove(),n(s)}),CoursePress.Course.on("coursepress:toggle_course_status_success",function(s){e('[name="publish-course-toggle"]').attr("data-nonce",s.nonce)}),CoursePress.Course.on("coursepress:toggle_course_status_error",function(){var s=e('[name="publish-course-toggle"]');e(s).hasClass("on")?e(s).removeClass("on").addClass("off"):e(s).hasClass("off")&&e(s).removeClass("off").addClass("on")}),CoursePress.Course.on("coursepress:enroll_student_success",function(){location.reload()}),CoursePress.Course.on("coursepress:withdraw_student_success",function(){location.reload()}),CoursePress.Course.on("coursepress:withdraw_all_students_success",function(){location.reload()}),CoursePress.Course.on("coursepress:invite_student_success",function(s){e(".invite-progress").detach(),e(".coursepress_course_invite_student_wrapper .invite-submit").attr("data-nonce",s.nonce)}),CoursePress.Course.on("coursepress:invite_student_error",function(){e(".invite-progress").detach()})}function c(){function r(){var r=e(s).is(":checked"),o=e(t).is(":checked");e("tbody tr").css("display","none");var n="";o?(e("tr.treegrid-expanded ~ tr.submitted").css("display","table-row"),e("tr.treegrid-expanded ~ tr.not-submitted").css("display","none"),n=".submitted"):(e("tr.treegrid-expanded ~ tr.submitted").css("display","table-row"),e("tr.treegrid-expanded ~ tr.not-submitted").css("display","table-row")),r?(e("tr.treegrid-expanded ~ tr.ungraded"+n).css("display","table-row"),e("tr.treegrid-expanded ~ tr.graded"+n).css("display","none")):(e("tr.treegrid-expanded ~ tr.ungraded"+n).css("display","table-row"),e("tr.treegrid-expanded ~ tr.graded"+n).css("display","table-row")),e("tbody tr.student-name").css("display","table-row")}var s='.coursepress_settings_wrapper.assessment .ungraded-elements [type="checkbox"]',t='.coursepress_settings_wrapper.assessment .submitted-elements [type="checkbox"]';e(s).on("click",function(){r(this)}),e(t).on("click",function(){r(this)}),e(".coursepress_settings_wrapper.assessment table").treegrid().on("expand",function(){r(this)}),e(".coursepress_settings_wrapper.assessment table .instructor-feedback").link_popup({link_text:'<span class="dashicons dashicons-admin-comments"></span>'}),e('.coursepress_settings_wrapper.assessment [name="course-list"]').on("change",function(){var s=e(this).val();location.href=_coursepress.assessment_grid_url+"&course_id="+s}),e(".coursepress_settings_wrapper.assessment .collapse-all-students").on("click",function(){e(".coursepress_settings_wrapper.assessment table").treegrid("collapseAll")}),e(".coursepress_settings_wrapper.assessment .expand-all-students").on("click",function(){e(".coursepress_settings_wrapper.assessment table").treegrid("expandAll")})}function u(){e(".coursepress_settings_wrapper.reports .help-tooltip").link_popup({link_text:'<span class="dashicons dashicons-editor-help"></span>',offset_x:20}),e('.coursepress_settings_wrapper.reports [name="course-list"]').on("change",function(){var s=e(this).val();location.href=_coursepress.assessment_report_url+"&course_id="+s}),e(".coursepress_settings_wrapper.reports .column-report .pdf").on("click",function(){if(!1===e(this).data("click"))return!1;var s=e(this).parents("form")[0],t=e(this).attr("data-student");e(s).find("[name=students]").val(t),s.submit()})}function l(){e('[name*="publish-notification-toggle"]').on("change",function(s,t){CoursePress.Post.prepare("update_notification","notification:"),CoursePress.Post.set("action","toggle");var r=e(this).attr("data-nonce"),o="off"===t?"draft":"publish",n=parseInt(e(this).attr("id").replace("publish-notification-toggle-","")),a={nonce:r,status:o,state:t,notification_id:n};CoursePress.Post.set("data",a),CoursePress.Post.save()}),e(".delete-notification-link").on("click",function(s){if(s.stopImmediatePropagation(),s.preventDefault(),window.confirm(_coursepress.notification_delete)){CoursePress.Post.prepare("update_notification","notification:"),CoursePress.Post.set("action","delete");var t={nonce:e(this).attr("data-nonce"),notification_id:e(this).attr("data-id")};CoursePress.Post.set("data",t),CoursePress.Post.save()}}),CoursePress.Post.on("coursepress:notification:delete_success",function(){location.reload()}),CoursePress.Post.on("coursepress:notification:toggle_error",function(s){var t=e("#publish-notification-toggle-"+s.ID);t.hasClass("on")?t.removeClass("on").addClass("off"):t.removeClass("off").addClass("on")}),e('.coursepress_communications_wrapper.notifications [id*="doaction"]').on("click",function(){var s=e(this).siblings('[id*="bulk-action-selector"]').val();if("delete"===s&&!window.confirm(_coursepress.notification_bulk_delete))return!1;if(void 0!==s&&-1!==s){var t=[];e.each(e('[name*="bulk-actions"]'),function(s,r){e(r).is(":checked")&&t.push(e(r).val())}),CoursePress.Post.prepare("update_notification","notification:"),CoursePress.Post.set("action","bulk_"+s);var r={nonce:e(".nonce-holder").attr("data-nonce"),ids:t};CoursePress.Post.set("data",r),CoursePress.Post.save()}}),CoursePress.Post.on("coursepress:notification:bulk_publish_success",function(){location.reload()}),CoursePress.Post.on("coursepress:notification:bulk_unpublish_success",function(){location.reload()}),CoursePress.Post.on("coursepress:notification:bulk_delete_success",function(){location.reload()})}function d(){e('[name*="publish-discussion-toggle"]').on("change",function(s,t){CoursePress.Post.prepare("update_discussion","discussion:"),CoursePress.Post.set("action","toggle");var r=e(this).attr("data-nonce"),o="off"===t?"draft":"publish",n=parseInt(e(this).attr("id").replace("publish-discussion-toggle-","")),a={nonce:r,status:o,state:t,discussion_id:n};CoursePress.Post.set("data",a),CoursePress.Post.save()}),e(".delete-discussion-link").on("click",function(s){if(s.stopImmediatePropagation(),s.preventDefault(),window.confirm(_coursepress.discussion_delete)){CoursePress.Post.prepare("update_discussion","discussion:"),CoursePress.Post.set("action","delete");var t={nonce:e(this).attr("data-nonce"),discussion_id:e(this).attr("data-id")};CoursePress.Post.set("data",t),CoursePress.Post.save()}}),CoursePress.Post.on("coursepress:discussion:delete_success",function(){location.reload()}),CoursePress.Post.on("coursepress:discussion:toggle_error",function(s){var t=e("#publish-discussion-toggle-"+s.ID);t.hasClass("on")?t.removeClass("on").addClass("off"):t.removeClass("off").addClass("on")}),e('.coursepress_communications_wrapper.discussions [id*="doaction"]').on("click",function(){var s=e(this).siblings('[id*="bulk-action-selector"]').val();if("delete"===s&&!window.confirm(_coursepress.discussion_bulk_delete))return!1;if(void 0!==s&&-1!==s){var t=[];e.each(e('[name*="bulk-actions"]'),function(s,r){e(r).is(":checked")&&t.push(e(r).val())}),CoursePress.Post.prepare("update_discussion","discussion:"),CoursePress.Post.set("action","bulk_"+s);var r={nonce:e(".nonce-holder").attr("data-nonce"),ids:t};CoursePress.Post.set("data",r),CoursePress.Post.save()}}),CoursePress.Post.on("coursepress:discussion:bulk_publish_success",function(){location.reload()}),CoursePress.Post.on("coursepress:discussion:bulk_unpublish_success",function(){location.reload()}),CoursePress.Post.on("coursepress:discussion:bulk_delete_success",function(){location.reload()}),e(".coursepress_communications_wrapper.discussions select#course_id").on("change",function(){var s=e(this).val();e.each(e(".coursepress_communications_wrapper.discussions select#unit_id").find("option"),function(s,t){"course"!==e(t).val()&&e(t).detach()}),CoursePress.Post.prepare("update_discussion","discussion:"),CoursePress.Post.set("action","unit_items");var t={course_id:s};CoursePress.Post.set("data",t),CoursePress.Post.save()}),CoursePress.Post.on("coursepress:discussion:unit_items_success",function(s){s.items.length>0&&e.each(s.items,function(s,t){e(".coursepress_communications_wrapper.discussions select#unit_id").append('<option value="'+t.key+'">'+t.value+"</option>")})})}function h(e){if(e.loading)return e.text;var s='<div class="select2-result-course clearfix">'+e.gravatar+" <span>"+e.display_name+"</span></div>";return s}function C(e){var s="";return s=e&&(e.gravatar||e.display_name)?'<div class="select2-result-course clearfix">'+e.gravatar+" <span>"+e.display_name+"</span></div>":_coursepress.labels.user_dropdown_placeholder}CoursePress.Models=CoursePress.Models||{},CoursePress.Models.Course=CoursePress.Models.Course||Backbone.Model.extend({url:_coursepress._ajax_url+"?action=update_course",parse:function(e){!0===e.success?(this.set("response_data",e.data),this.trigger("coursepress:"+e.data.action+"_success",e.data)):(this.set("response_data",{}),this.trigger("coursepress:"+e.data.action+"_error",e.data)),CoursePress.Course.set("action","")},defaults:{}}),CoursePress.Course=new CoursePress.Models.Course,CoursePress.Models.Post=CoursePress.Models.Post||Backbone.Model.extend({url:_coursepress._ajax_url+"?action=",parse:function(e){var s=this.get("context");if(!0===e.success){void 0===e.data&&(e.data={}),this.set("response_data",e.data);var t="coursepress:"+s+e.data.action+"_success";
this.trigger(t,e.data)}else 0!==e&&(this.set("response_data",{}),this.trigger("coursepress:"+s+e.data.action+"_error",e.data));CoursePress.Course.set("action","")},prepare:function(e,s){this.url=this.get("base_url")+e,void 0!==s&&this.set("context",s)},defaults:{base_url:_coursepress._ajax_url+"?action=",context:"response:"}}),CoursePress.Post=new CoursePress.Models.Post,CoursePress.Course.multiple_elements=function(s,t){var r=0;return e.each(s,function(e,s){t===s.name&&(r+=1)}),r>1},CoursePress.Course.add_array_to_data=function(s,t){var r=0,o="";e.each(t,function(e,n){var a=n.name.replace(/(\[|\]\[)/g,"/").replace(/\]/g,"");o!==a&&(r=0),a.match(/\/$/g)||CoursePress.Course.multiple_elements(t,n.name)?a.match(/\/$/g)?CoursePress.utility.update_object_by_path(s,a+r,n.value):CoursePress.utility.update_object_by_path(s,a+"/"+r,n.value):CoursePress.utility.update_object_by_path(s,a,n.value),r+=1,o=a})},CoursePress.Course.fix_step_checkboxes=function(e,s,t){return CoursePress.utility.fix_checkboxes(e,".step-content.step-"+s,t)},CoursePress.Course.hasError=!1,CoursePress.Course.get_step=function(s,t){void 0===t&&(t="next");var o,r={};if(r.step=s,r.is_finished=!1,s>=1&&(r.course_id=e('[name="course_id"]').val(),r.course_name=e('[name="course_name"]').val(),r.course_excerpt=tinyMCE&&tinyMCE.get("courseExcerpt")?tinyMCE.get("courseExcerpt").getContent():e('[name="course_excerpt"]').val(),o=e('.cp-box-content.step-1 [name^="meta_"]').serializeArray(),o=CoursePress.Course.fix_step_checkboxes(o,s),CoursePress.Course.add_array_to_data(r,o)),s>=2&&(r.course_description=tinyMCE&&tinyMCE.get("courseDescription")?tinyMCE.get("courseDescription").getContent():e('[name="course_description"]').val(),o=e('.cp-box-content.step-2 [name^="meta_"]').serializeArray(),o=CoursePress.Course.fix_step_checkboxes(o,s,"0"),CoursePress.Course.add_array_to_data(r,o)),s>=3&&(o=e('.cp-box-content.step-3 [name^="meta_"]').serializeArray(),o=CoursePress.Course.fix_step_checkboxes(o,s,"0"),CoursePress.Course.add_array_to_data(r,o)),s>=4&&(o=e('.cp-box-content.step-4 [name^="meta_"]').serializeArray(),o=CoursePress.Course.fix_step_checkboxes(o,s,"0"),CoursePress.Course.add_array_to_data(r,o)),s>=5&&(o=e('.cp-box-content.step-5 [name^="meta_"]').serializeArray(),o=CoursePress.Course.fix_step_checkboxes(o,s,"0"),CoursePress.Course.add_array_to_data(r,o)),s>=6&&(o=e('.cp-box-content.step-6 [name^="meta_"]').serializeArray(),o=CoursePress.Course.fix_step_checkboxes(o,s,"0"),CoursePress.Course.add_array_to_data(r,o)),s>=7){course_completion_content=tinyMCE&&tinyMCE.get("course-completion-editor-content")?tinyMCE.get("course-completion-editor-content").getContent():e('[name="meta_course_completion_content"]').val(),e('[name="meta_course_completion_content"]').val(course_completion_content),pre_completion_content=tinyMCE&&tinyMCE.get("pre-completion-content")?tinyMCE.get("pre-completion-content").getContent():e('[name="meta_pre_completion_content"]').val(),e('[name="meta_pre_completion_content"]').val(pre_completion_content),failed_content=tinyMCE&&tinyMCE.get("course-failed-content")?tinyMCE.get("course-failed-content").getContent():e('[name="meta_course_failed_content"]').val(),e('[name="meta_course_failed_content"]').val(failed_content),basic_certificate_layout=tinyMCE&&tinyMCE.get("basic-certificate-layout")?tinyMCE.get("basic-certificate-layout").getContent():e('[name="meta_basic_certificate_layout"]').val(),e('[name="meta_basic_certificate_layout"]').val(basic_certificate_layout),o=e('.cp-box-content.step-7 [name^="meta_"]').serializeArray();var n=e('[name="meta_basic_certificate"]').is(":checked");n||o.push({name:"meta_basic_certificate",value:!1}),o=CoursePress.Course.fix_step_checkboxes(o,s,"0"),CoursePress.Course.add_array_to_data(r,o)}var i=e("#course_categorychecklist input:checked"),c=[];0<i.length&&(i.each(function(){var s=e(this);c.push({name:"meta_course_category",value:s.val()})}),CoursePress.Course.add_array_to_data(r,c));var u=s;"next"===t&&(r.meta_setup_marker=s,u=7!==u?u+1:u),"prev"===t&&(r.meta_setup_marker=s-1,u=1!==u?u-1:u),"finish"===t&&(r.meta_setup_marker=s,r.is_finished=!0),r.post_status=e("#post_status").val(),r.nonce=a(),CoursePress.Course.set("data",r),CoursePress.Course.set("action","update_course"),CoursePress.Course.set("next_step",u)},CoursePress.Course.show_message=function(s,t){e(".cp-box-content .course-step-buttons .notice").detach(),e(".cp-box-content.ui-accordion-content-active .course-step-buttons").prepend('<div class="notice notice-'+t+'"><p>'+s+"</p></div>"),"success"===t&&setTimeout(function(){e(".cp-box-content .course-step-buttons .notice").fadeOut()},3e3)};var p=function(){var s=e(this),t=s.is(":checked"),r=e(".btn-cert"),o=e(this).closest(".wide.course-certificate");r[t?"addClass":"removeClass"]("button-primary"),t?e(".options, .btn-cert",o).slideDown():e(".options, .btn-cert",o).slideUp()},m=function(){var s=e(this),t=s.is(":checked"),r=e(this).closest(".wide");t?e(".column-time",r).show():e(".column-time",r).hide()},v={placeholder:_coursepress.labels.user_dropdown_placeholder,allowClear:!0,ajax:{url:_coursepress._ajax_url,dataType:"json",delay:250,data:function(s){return{q:s.term,page:s.page,action:"coursepress_user_search",course_id:_coursepress.course_id,_wpnonce:e(this).data("nonce-search")}},processResults:function(e,s){return s.page=s.page||1,{results:e.items,pagination:{more:30*s.page<e.total_count}}},cache:!0},escapeMarkup:function(e){return e},minimumInputLength:3,templateResult:h,templateSelection:C};CoursePress.updateCourse=function(){var s=e(this),t=e("#course-setup-steps .cp-box-content:visible .step.next");if(finishbutton=e("#course-setup-steps .cp-box-content:visible .finish.step-7"),0===t.length&&0===finishbutton.length){var o=(e('[name="s"]',s),e('[name="_wp_http_referer"]'));return s.attr("action",o.val()),!0}if(0===finishbutton.length)t.trigger("click");else{finishbutton.trigger("click");var n=s.serialize();CoursePress.Course.hasError||e.post(s.attr("action"),n)}return!1},CoursePress.maybeUpdateCourse=function(){var s=e("form#post"),t=e(this);if(0==s.length)return!0;if(t.is("#search-submit")){var r=s.find('[name="_wp_http_referer"]'),o=s.find('[name="s"]').val();return r=r.val()+"&s="+o,window.location=r,!1}if(t.is("#post-preview")){var n=t.attr("href");window.open(n)}return s.unbind("submit").submit(),!1},e(document).ready(function(){t(),r(),i(),c(),u(),l(),d();var s=jQuery("#course-setup-steps .step-title .status.setup_marker");s.click(),e('[name="meta_basic_certificate"]').each(p),"function"==typeof e().select2&&e("#student-add, #facilitators, #instructors").select2(v).on("select2:selecting",function(){e("input.button.disabled",e(this).closest(".wide")).removeClass("disabled")}).on("select2:unselecting",function(){e("input.button",e(this).closest(".wide")).addClass("disabled")}),e(".course-edit-notification .save-post-status, .course-edit-forums .save-post-status").click(function(){e("#post-status-display").html(e("option:selected",e("#post-status-select")).text())}),e(".course-edit-notification input[type=submit], .course-edit-forums input[type=submit]").click(function(){var t=e(".course-edit-notification").length>0,r=e(".course-edit-forums").length>0,o=[],n=!1;if(""===e("#titlewrap input[name=post_title]").val()&&o.push(t?_coursepress.messages.notification.empty_title:r?_coursepress.messages.discussion.empty_title:_coursepress.messages.general.empty_title),e(".wp-editor-wrap").hasClass("tmce-active")){var a=tinymce.activeEditor.getBody(),i=tinymce.trim(a.innerText||a.textContent);0===i.length&&(n=!0)}else""===e(".wp-editor-wrap .wp-editor-area").val()&&(n=!0);return n&&o.push(t?_coursepress.messages.notification.empty_content:r?_coursepress.messages.discussion.empty_content:_coursepress.messages.general.empty_content),o.length?(alert(o.join("\n")),!1):(e(this).hasClass("button-primary")&&e(this).hasClass("force-publish")&&e("#post_status").val("publish"),!0)}),e("#course_id").change(function(){"all"===e("option:selected",e(this)).val()?(e("#post-visibility-display").html(e("#misc-publishing-actions").data("no-options")),e("#visibility a.edit-visibility").hide()):(e("#post-visibility-display").html(e("input:checked",e("#visibility")).data("info")),e("#visibility a.edit-visibility").show())}),e(".course-edit-notification .save-post-visibility").click(function(){e("#post-visibility-display").html(e("input:checked",e("#visibility")).data("info"))})}).on("click",".btn-cert",function(){var s=e(this),t=s.is(".button-primary");if(!t)return!1;tinymce.triggerSave();var r=e("input, textarea",e(".course-certificate")).serialize(),o=[s.attr("href"),r];return window.open(o.join("&"),"_blank"),!1}).on("change",'[name="meta_basic_certificate"]',p).on("change",'[name="meta_structure_show_duration"]',m).on("click",".post-type-course #publish, .post-type-course #search-submit, .post-type-course #post-preview",CoursePress.maybeUpdateCourse).on("submit",".post-type-course form#post",CoursePress.updateCourse)}(jQuery);